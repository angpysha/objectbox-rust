# –Ø–∫ –ø—Ä–∞—Ü—é—é—Ç—å Relations (–≤–∫–ª–∞–¥–µ–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ) –≤ ObjectBox

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è

ObjectBox **–ù–ï** –∑–±–µ—Ä—ñ–≥–∞—î –≤–∫–ª–∞–¥–µ–Ω—ñ –æ–±'—î–∫—Ç–∏ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ. –ù–∞—Ç–æ–º—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **—Ä–µ–ª—è—Ü—ñ–π–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ (references)**.

## üìö –¢–∏–ø–∏ –≤—ñ–¥–Ω–æ—à–µ–Ω—å (Relations)

### 1. **ToOne** (–æ–¥–∏–Ω-–¥–æ-–æ–¥–Ω–æ–≥–æ)

```rust
// –ü—Ä–∏–∫–ª–∞–¥ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ):
#[entity]
pub struct Order {
    #[id]
    pub id: u64,
    pub order_number: String,
    
    // –í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –¥–æ Customer
    pub customer: ToOne<Customer>,  // –¶–µ –ù–ï –≤–∫–ª–∞–¥–µ–Ω–∏–π –æ–±'—î–∫—Ç!
}

#[entity]
pub struct Customer {
    #[id]
    pub id: u64,
    pub name: String,
}
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î**:
- `ToOne<Customer>` - —Ü–µ **–æ–±–≥–æ—Ä—Ç–∫–∞ –Ω–∞–≤–∫–æ–ª–æ ID** (–Ω–µ —Å–∞–º Customer)
- –í –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ `customer_id: u64`
- ObjectBox –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î "–≤—ñ—Ä—Ç—É–∞–ª—å–Ω—É" –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `customerId`

### 2. **ToMany** (–æ–¥–∏–Ω-–¥–æ-–±–∞–≥–∞—Ç—å–æ—Ö)

```rust
// –ü—Ä–∏–∫–ª–∞–¥ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ):
#[entity]
pub struct Customer {
    #[id]
    pub id: u64,
    pub name: String,
    
    // –í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –¥–æ –±–∞–≥–∞—Ç—å–æ—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å
    pub orders: ToMany<Order>,
}
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î**:
- `ToMany<Order>` - —Ü–µ **–∫–æ–ª–µ–∫—Ü—ñ—è ID** (–Ω–µ —Å–∞–º—ñ Order –æ–±'—î–∫—Ç–∏)
- ObjectBox —Å—Ç–≤–æ—Ä—é—î –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é –∑–≤'—è–∑–∫—ñ–≤ (relation table)
- –†–µ–∞–ª—å–Ω—ñ Order –æ–±'—î–∫—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

### –ü—Ä–∏–∫–ª–∞–¥: Order ‚Üí Customer (ToOne)

**–¢–∞–±–ª–∏—Ü—è Order**:
```
| id | order_number | customer_id |
|----|--------------|-------------|
| 1  | ORD-001      | 101         |
| 2  | ORD-002      | 101         |
| 3  | ORD-003      | 102         |
```

**–¢–∞–±–ª–∏—Ü—è Customer**:
```
| id  | name      |
|-----|-----------|
| 101 | John Doe  |
| 102 | Jane Smith|
```

### –ü—Ä–∏–∫–ª–∞–¥: Customer ‚Üí Orders (ToMany)

**–¢–∞–±–ª–∏—Ü—è –∑–≤'—è–∑–∫—ñ–≤ (Relation Table)**:
```
| customer_id | order_id |
|-------------|----------|
| 101         | 1        |
| 101         | 2        |
| 102         | 3        |
```

## ‚öôÔ∏è –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î –ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º

### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ Relation

```rust
// –í model.rs (—Ä—è–¥–æ–∫ 131-147)
pub fn property_relation(
    mut self,
    target_entity_name: &str,
    index_id: c::obx_schema_id,
    index_uid: c::obx_uid,
) -> Self
```

–¶–µ–π –º–µ—Ç–æ–¥:
- –û–≥–æ–ª–æ—à—É—î ToOne relation
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î —ñ–Ω–¥–µ–∫—Å –Ω–∞ `target_id`
- –ó–±–µ—Ä—ñ–≥–∞—î —ñ–º'—è —Ü—ñ–ª—å–æ–≤–æ—ó —Å—É—Ç–Ω–æ—Å—Ç—ñ

### 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è standalone ToMany relation

```rust
// –í model.rs (—Ä—è–¥–æ–∫ 149-170)
pub fn relation(
    mut self,
    relation_id: c::obx_schema_id,
    relation_uid: c::obx_uid,
    target_entity_id: c::obx_schema_id,
    target_entity_uid: c::obx_uid,
) -> Self
```

–¶–µ–π –º–µ—Ç–æ–¥:
- –°—Ç–≤–æ—Ä—é—î –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é –∑–≤'—è–∑–∫—ñ–≤
- –ó–±–µ—Ä—ñ–≥–∞—î –ø–∞—Ä–∏ (source_id, target_id)

### 3. –¢–∏–ø–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π

```rust
// OBXPropertyType_Relation = 11  (–∑ objectbox.h)
```

–¶–µ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π —Ç–∏–ø –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ, —è–∫–∏–π –∫–∞–∂–µ ObjectBox:
- –¶–µ –Ω–µ —Ä–µ–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è, –∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ ID —ñ–Ω—à–æ—ó —Å—É—Ç–Ω–æ—Å—Ç—ñ
- –ü–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É

## üîÑ –ü—Ä–æ—Ü–µ—Å —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó/–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### ToOne Serialization (–ó–∞–ø–∏—Å)

```
Order object:
‚îú‚îÄ id: 1
‚îú‚îÄ order_number: "ORD-001"
‚îî‚îÄ customer: ToOne<Customer>
     ‚îî‚îÄ target_id: 101  ‚Üê –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ü–µ!

FlatBuffers:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id: 1            ‚îÇ
‚îÇ order_number: .. ‚îÇ
‚îÇ customerId: 101  ‚îÇ ‚Üê –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ToOne Deserialization (–ß–∏—Ç–∞–Ω–Ω—è)

```
1. –ß–∏—Ç–∞—î–º–æ FlatBuffers:
   customerId = 101

2. –°—Ç–≤–æ—Ä—é—î–º–æ Order:
   order.customer = ToOne<Customer> { target_id: 101 }

3. –ü—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ order.customer.get():
   ‚Üí ObjectBox –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î Customer –∑ id=101
   ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∞–ª—å–Ω–∏–π Customer –æ–±'—î–∫—Ç
```

### ToMany Serialization

```
Customer object:
‚îú‚îÄ id: 101
‚îú‚îÄ name: "John"
‚îî‚îÄ orders: ToMany<Order>
     ‚îî‚îÄ relation_ids: [1, 2]  ‚Üê –¢—ñ–ª—å–∫–∏ ID!

Relation Table:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ customer_id  ‚îÇ order_id ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 101          ‚îÇ 1        ‚îÇ
‚îÇ 101          ‚îÇ 2        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Lazy Loading (–õ—ñ–Ω–∏–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)

**–ö–ª—é—á–æ–≤–∞ –æ—Å–æ–±–ª–∏–≤—ñ—Å—Ç—å**: Relations –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –¥–æ –Ω–∏—Ö –∑–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è!

```rust
// 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏ Order
let order = box.get(order_id)?;

// 2. –í —Ü–µ–π –º–æ–º–µ–Ω—Ç Customer –©–ï –ù–ï –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π!
// order.customer –º—ñ—Å—Ç–∏—Ç—å —Ç—ñ–ª—å–∫–∏ ID=101

// 3. –¢—ñ–ª—å–∫–∏ —Ç—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞–ø–∏—Ç –¥–æ –ë–î
let customer = order.customer.get()?;  // ‚Üê DB query —Ç—É—Ç!
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:
- ‚ö° –®–≤–∏–¥—à–µ: –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ
- üíæ –ú–µ–Ω—à–µ –ø–∞–º'—è—Ç—ñ: —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
- üéØ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–µ: –∫–æ–∂–Ω–∞ —Å—É—Ç–Ω—ñ—Å—Ç—å - –æ–∫—Ä–µ–º–∏–π –∑–∞–ø–∏—Ç

## üîç –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ Rust —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω (TODO —É –∫–æ–¥—ñ)

```rust
// src/traits.rs (—Ä—è–¥–æ–∫ 19-28)
// TODO
/*
pub trait RelationExt {
  fn to_one_relation<T>(&self) -> T;
  fn to_many_relations(&self) -> Any
}
*/
```

**–¶–µ –æ–∑–Ω–∞—á–∞—î**: Relations traits —â–µ –Ω–µ –ø–æ–≤–Ω—ñ—Å—Ç—é —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –≤ Rust –≤–µ—Ä—Å—ñ—ó!

### –©–æ —î –≤ JSON –º–æ–¥–µ–ª—ñ

```json
// fb_binding/src/objectbox-model.json
{
  "entities": [...],
  "lastRelationId": "",      // ‚Üê –î–ª—è ToMany
  "retiredRelationUids": [], // ‚Üê –í–∏–¥–∞–ª–µ–Ω—ñ relations
  "relations": [...]         // ‚Üê –°–ø–∏—Å–æ–∫ relations
}
```

### –ü—Ä–∞–ø–æ—Ä—Ü—ñ –¥–ª—è Relations

```rust
// –ó generator/src/ob_consts.rs
OBXPropertyFlags_INDEXED = 8              // Auto –¥–ª—è relations
OBXPropertyFlags_INDEX_PARTIAL_SKIP_ZERO = 512  // –ü—Ä–æ–ø—É—Å–∫ NULL relations
```

–î–ª—è ToOne –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- ‚úÖ –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —ñ–Ω–¥–µ–∫—Å
- ‚úÖ –î–æ–¥–∞—î—Ç—å—Å—è `INDEX_PARTIAL_SKIP_ZERO` (–¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤)

## üìä –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—ñ–¥—Ö–æ–¥—ñ–≤

### ‚ùå –í–∫–ª–∞–¥–µ–Ω—ñ –æ–±'—î–∫—Ç–∏ (—è–∫ JSON)

```json
{
  "order": {
    "id": 1,
    "customer": {            // ‚Üê –í–∫–ª–∞–¥–µ–Ω–∏–π –æ–±'—î–∫—Ç
      "id": 101,
      "name": "John Doe",
      "address": {...}
    }
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏**:
- üîÑ –î—É–±–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (Customer –≤ –∫–æ–∂–Ω–æ–º—É Order)
- üì¶ –í–µ–ª–∏–∫–∏–π —Ä–æ–∑–º—ñ—Ä
- üîß –°–∫–ª–∞–¥–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ (—Ç—Ä–µ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ —É –≤—Å—ñ—Ö Order)

### ‚úÖ ObjectBox –ø—ñ–¥—Ö—ñ–¥ (References)

```json
Order Table:
{ "id": 1, "customer_id": 101 }

Customer Table:
{ "id": 101, "name": "John Doe" }
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:
- ‚ú® –ù–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è
- üéØ –ï—Ñ–µ–∫—Ç–∏–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
- üíæ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø–∞–º'—è—Ç—ñ
- ‚ö° Lazy loading

## üé≠ –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ)

### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è

```rust
// 1. –°—Ç–≤–æ—Ä—é—î–º–æ Customer
let mut customer = Customer {
    id: 0,
    name: "John Doe".to_string(),
};
customer_box.put(&mut customer)?;  // id —Å—Ç–∞—î 101

// 2. –°—Ç–≤–æ—Ä—é—î–º–æ Order –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
let mut order = Order {
    id: 0,
    order_number: "ORD-001".to_string(),
    customer: ToOne::new(customer.id),  // ‚Üê –¢—ñ–ª—å–∫–∏ ID!
};
order_box.put(&mut order)?;
```

### 2. –ß–∏—Ç–∞–Ω–Ω—è –∑ relation

```rust
// 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ Order
let order = order_box.get(1)?;

// 2. –û—Ç—Ä–∏–º—É—î–º–æ Customer —á–µ—Ä–µ–∑ relation
let customer = order.customer.get(&store)?;  // ‚Üê –û–∫—Ä–µ–º–∏–π DB query

println!("Order {} –≤—ñ–¥ {}", 
    order.order_number, 
    customer.name
);
```

### 3. ToMany —Ä–æ–±–æ—Ç–∞

```rust
// 1. –û—Ç—Ä–∏–º—É—î–º–æ Customer
let customer = customer_box.get(101)?;

// 2. –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ Order —Ü—å–æ–≥–æ Customer
let orders = customer.orders.get_all(&store)?;  // ‚Üê Query –¥–æ relation table

for order in orders {
    println!("Order: {}", order.order_number);
}
```

## üéØ –í–∏—Å–Ω–æ–≤–æ–∫

**ObjectBox Relations - —Ü–µ:**

1. **–ü–æ—Å–∏–ª–∞–Ω–Ω—è, –Ω–µ –≤–∫–ª–∞–¥–µ–Ω—ñ –æ–±'—î–∫—Ç–∏**
   - –ó–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è ID, –Ω–µ –ø–æ–≤–Ω—ñ –æ–±'—î–∫—Ç–∏

2. **–ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö**
   - –ö–æ–∂–Ω–∞ —Å—É—Ç–Ω—ñ—Å—Ç—å –∂–∏–≤–µ –≤ —Å–≤–æ—ó–π —Ç–∞–±–ª–∏—Ü—ñ

3. **Lazy loading**
   - –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ

4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—è**
   - –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –∑–∞ relations

5. **–û–∫—Ä–µ–º—ñ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è ToMany**
   - –ï—Ñ–µ–∫—Ç–∏–≤–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–≥–∞—Ç—å–º–∞ –∑–≤'—è–∑–∫–∞–º–∏

**–í Rust —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó**: –ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —î, –∞–ª–µ traits –¥–ª—è –∑—Ä—É—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ (–≤—ñ–¥–º—ñ—á–µ–Ω—ñ —è–∫ TODO).
